<ion-header translucent>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title class="">
      Ambulant Stall Collections
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content fullscreen class="collections-content">

  <!-- Filter Section -->
  <div class="filter-bar">
    <span class="filter-label">Filter by date</span>

    <ion-datetime-button datetime="datetime"></ion-datetime-button>
    <ion-modal [keepContentsMounted]="true">
      <ng-template>
        <ion-datetime
          id="datetime"
          presentation="date"
          [(ngModel)]="dateFilter"
          (ngModelChange)="filter()">
        </ion-datetime>
      </ng-template>
    </ion-modal>
  </div>

  <!-- Floating Action Button -->
  <ion-fab slot="fixed" vertical="bottom" horizontal="end">
    <ion-fab-button id="add-collection-modal">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <!-- List -->
  <ion-list class="collections-list">
    <ion-list-header class="list-header">
      Daily Collections
    </ion-list-header>

    @for (fee of feeService.fees; track fee) {
      <ion-item-sliding>

        <ion-item lines="none" class="collection-card">
          <ion-icon
            slot="start"
            name="receipt-outline"
            class="receipt-icon">
          </ion-icon>

          <div class="collection-details">
            <p class="stall-name">
              {{ fee.ambulant_stall?.name }}
            </p>
            <p class="amount">
              {{ fee.amount | currency : 'â‚± ' }}
            </p>
            <p class="date">
              {{ fee.date_issued | date:'mediumDate' }}
            </p>
          </div>

          <span
            slot="end"
            class="status-badge"
            [class.paid]="fee.status === 'PAID'"
            [class.unpaid]="fee.status === 'UNPAID'">
            {{ fee.status }}
          </span>
        </ion-item>

        <ion-item-options>
          @if (fee.status === 'UNPAID') {
            <ion-item-option
              color="success"
              (click)="showUpdateCollectionModal(fee)">
              Update
            </ion-item-option>
          }
        </ion-item-options>

      </ion-item-sliding>
    }

    <ion-item *ngIf="feeService.fees.length === 0" lines="none">
      <p class="empty-state">
        No daily collections found
      </p>
    </ion-item>
  </ion-list>

</ion-content>


<!-- add collection modal -->
<ion-modal trigger="add-collection-modal" #addCollectionModal >
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="cancel()">Cancel</ion-button>
        </ion-buttons>
        <ion-title>Add Collection</ion-title>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding">
      <form [formGroup]="addCollectionForm" (ngSubmit)="submitCollection()">
        <ion-list>
          <ion-item>
            <ion-select label="Select Ambulant Stall" formControlName="ambulant_stall"  labelPlacement="floating">
              @for(stall of ambulantStallService.ambulantStalls; track stall; let i = $index) {
                <ion-select-option [value]="stall.id">{{stall.name}}</ion-select-option>
              }
            </ion-select>
          </ion-item>
          @if(errors?.ambulant_stall) {
            <small class="text-danger" >{{errors?.stall_occupant[0]}}</small>
          }

          <ion-item>
            <ion-input type="number" placeholder="Amount" labelPlacement="floating" label="Amount" formControlName="amount"></ion-input>
          </ion-item>
          @if(errors?.amount) {
            <small class="text-danger" >{{errors?.stall_occupant[0]}}</small>
          }

          <ion-item>
            <ion-select label="Select Status" formControlName="status" labelPlacement="floating">
              <ion-select-option value="PAID">Paid</ion-select-option>
              <ion-select-option value="UNPAID">Unpaid</ion-select-option>
            </ion-select>
          </ion-item>
          @if(errors?.status) {
            <small class="text-danger" >{{errors?.status[0]}}</small>
          }

          <!-- @if(addCollectionForm.value.status == 'PAID') {
            <ion-item>
              <ion-input type="date" placeholder="Date Paid" labelPlacement="floating" label="Date Paid" formControlName="date_paid"></ion-input>
            </ion-item>
            @if(errors?.date_paid) {
              <small class="text-danger" >{{errors?.date_paid[0]}}</small>
            }
            <ion-item>
              <ion-input type="text" placeholder="Receipt No" labelPlacement="floating" label="Receipt No" formControlName="receipt_no"></ion-input>
            </ion-item>
            @if(errors?.receipt_no) {
              <small class="text-danger" >{{errors?.receipt_no[0]}}</small>
            }
          } -->
          <ion-item>
            <ion-textarea label="Remarks" placeholder="Enter Remarks Here" labelPlacement="floating" formControlName="remarks"></ion-textarea>
          </ion-item>
        </ion-list>
        <br>
        <ion-button expand="block" type="submit" [disabled]="!addCollectionForm.valid">Save</ion-button>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- update collection modal -->
<ion-modal trigger="update-collection-modal" #updateCollectionModal >
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="cancel()">Cancel</ion-button>
        </ion-buttons>
        <ion-title>Add Collection</ion-title>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding">
      <form [formGroup]="updateCollectionForm" (ngSubmit)="submitUpdateCollection()">
        <ion-list>
          <ion-item>
              <ion-input type="date" placeholder="Date Paid" labelPlacement="floating" label="Date Paid" formControlName="date_paid"></ion-input>
            </ion-item>
            @if(errors?.date_paid) {
              <small class="text-danger" >{{errors?.date_paid[0]}}</small>
            }
            <ion-item>
              <ion-input type="text" placeholder="Receipt No" labelPlacement="floating" label="Receipt No" formControlName="receipt_no"></ion-input>
            </ion-item>
            @if(errors?.receipt_no) {
              <small class="text-danger" >{{errors?.receipt_no[0]}}</small>
            }
          <ion-item>
            <ion-textarea label="Remarks" placeholder="Enter Remarks Here" labelPlacement="floating" formControlName="remarks"></ion-textarea>
          </ion-item>
        </ion-list>
        <br>
        <ion-button expand="block" type="submit" [disabled]="!updateCollectionForm.valid">Update</ion-button>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>


