<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title class="page-title">Delivery Fee Collections</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content fullscreen class="delivery-content">

  <!-- Floating Action Button -->
  <ion-fab slot="fixed" vertical="bottom" horizontal="end">
    <ion-fab-button id="add-delivery-modal">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <!-- Filter Section -->
  <div class="filter-bar">
    <span class="filter-label">Filter by date</span>

    <ion-datetime-button datetime="datetime"></ion-datetime-button>
    <ion-modal [keepContentsMounted]="true">
      <ng-template>
        <ion-datetime
          id="datetime"
          presentation="date"
          [(ngModel)]="dateFilter"
          (ngModelChange)="filter()">
        </ion-datetime>
      </ng-template>
    </ion-modal>
  </div>

  <!-- Deliveries List -->
  <ion-list class="delivery-list">
    @for (delivery of deliveries; track delivery) {
      <ion-item lines="none" class="delivery-card">
        <ion-icon name="pricetag-outline" slot="start" class="delivery-icon"></ion-icon>

        <div class="delivery-details">
          <p class="supplier-name">{{ delivery.supplier.name }}</p>
          <p class="delivery-date mb-0">{{ delivery.delivery_date | date:'mediumDate' }}</p>
          <p class="delivery-date mb-0">{{ delivery.delivery_items.length }} item/s delivered</p>
        <ion-buttons slot="end">
          <!-- <ion-button color="primary" expand="block" (click)="showUpdateDeliveryModal(delivery)">Update</ion-button> -->
        </ion-buttons>
        </div>
      </ion-item>
    }

    <ion-item *ngIf="deliveries.length === 0" lines="none">
      <p class="empty-state">No deliveries found</p>
    </ion-item>
  </ion-list>

</ion-content>

<!-- Add Delivery Modal -->
<ion-modal trigger="add-delivery-modal" #addDeliveryModal>
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="cancelAddDelivery()">Cancel</ion-button>
        </ion-buttons>
        <ion-title>Add Delivery Collection</ion-title>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding add-delivery-content">
      <form [formGroup]="addDeliveryForm" (ngSubmit)="storeDelivery()">

        <ion-card class="add-delivery-card">
          <ion-card-content>
            <!-- Delivery Date -->
            <div class="form-group">
              <ion-item>
                <ion-input type="date" label="Date Delivered" labelPlacement="floating" formControlName="delivery_date"></ion-input>
              </ion-item>
              <div *ngIf="errors?.delivery_date" class="error-msg">
                <small>{{ errors?.delivery_date[0] }}</small>
              </div>
            </div>

            <!-- Supplier Select -->
            <div class="form-group">
              <ion-item>
                <ion-select label="Select Supplier" labelPlacement="floating" formControlName="supplier">
                  @for(supplier of suppliers; track supplier) {
                    <ion-select-option [value]="supplier.id">{{ supplier.name }}</ion-select-option>
                  }
                </ion-select>
              </ion-item>
              <div *ngIf="errors?.supplier" class="error-msg">
                <small>{{ errors?.supplier[0] }}</small>
              </div>
            </div>

          </ion-card-content>
        </ion-card>

        <div formArrayName="items">
          
          <div *ngFor="let item of items.controls; let i = index" [formGroupName]="i" class="delivery-item-row">
            <ion-card>
              <ion-card-content>
                <ion-item>
                  <ion-select placeholder="Item" formControlName="item" label="Item" (ionChange)="onItemChange(i)">
                    @for(item of getAvailableItems(i); track item) {
                      <ion-select-option [value]="item.id">{{ item.name }}</ion-select-option>
                    }
                  </ion-select>
                </ion-item>
    
                <ion-item>
                  <ion-select placeholder="Unit" formControlName="unit" label="Unit">
                    @for(unit of units; track unit) {
                      <ion-select-option [value]="unit.id">{{ unit.name }}</ion-select-option>
                    }
                  </ion-select>
                </ion-item>

                <ion-item>
                  <ion-select placeholder="Origin" formControlName="origin" label="Origin">
                    @for(origin of origins; track origin) {
                      <ion-select-option [value]="origin.id">{{ origin.name }}</ion-select-option>
                    }
                  </ion-select>
                </ion-item>
    
                <ion-item >
                  <ion-input type="number" placeholder="Quantity" formControlName="quantity" label="Quantity" (ionChange)="onCalculateTax(i)"></ion-input>
                </ion-item>
    
                <!-- <ion-item>
                  <ion-input type="number" placeholder="Total Sales" formControlName="total_sales" label="Total Sales" (ionChange)="onTotalSalesChange(i)"></ion-input>
                </ion-item> -->
    
                <ion-item>
                  <ion-input type="number" placeholder="Tax" formControlName="tax" label="Tax" ></ion-input>
                </ion-item>
    
                <!-- <ion-item>
                  <ion-input placeholder="Ticket No." formControlName="ticket_no" label="Ticket No."></ion-input>
                </ion-item> -->
    
                <!-- <ion-item>
                  <ion-select placeholder="Ticket Status" formControlName="ticket_status" label="Ticket Status">
                    <ion-select-option value="PAID">PAID</ion-select-option>
                    <ion-select-option value="UNPAID">UNPAID</ion-select-option>
                  </ion-select>
                </ion-item> -->
    
                <ion-button color="danger" (click)="removeItem(i)">Remove</ion-button>
              </ion-card-content>
            </ion-card>
            
          </div>
        </div>

        <ion-button expand="block" (click)="addItem()">Add Item</ion-button>


        <ion-button expand="block" type="submit" [disabled]="!addDeliveryForm.valid" class="save-button">
          Save
        </ion-button>

      </form>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal trigger="update-delivery-modal" #updateDeliveryModal>
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="cancelUpdateDelivery()">Cancel</ion-button>
        </ion-buttons>
        <ion-title>Update Delivery Collection</ion-title>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding add-delivery-content">
      <form [formGroup]="updateDeliveryForm" (ngSubmit)="updateDelivery()">

        <ion-card class="add-delivery-card">
          <ion-card-content>
            <!-- Delivery Date -->
            <div class="form-group">
              <ion-item>
                <ion-input type="date" label="Date Delivered" labelPlacement="floating" formControlName="delivery_date"></ion-input>
              </ion-item>
              <div *ngIf="errors?.delivery_date" class="error-msg">
                <small>{{ errors?.delivery_date[0] }}</small>
              </div>
            </div>

            <!-- Supplier Select -->
            <div class="form-group">
              <ion-item>
                <ion-select label="Select Supplier" labelPlacement="floating" formControlName="supplier">
                  @for(supplier of suppliers; track supplier) {
                    <ion-select-option [value]="supplier.id">{{ supplier.name }}</ion-select-option>
                  }
                </ion-select>
              </ion-item>
              <div *ngIf="errors?.supplier" class="error-msg">
                <small>{{ errors?.supplier[0] }}</small>
              </div>
            </div>

          </ion-card-content>
        </ion-card>

        <div formArrayName="items">
          
          <div *ngFor="let item of toUpdateItems.controls; let i = index" [formGroupName]="i" class="delivery-item-row">
            <ion-card>
              <ion-card-content>
                <ion-item>
                  <ion-select placeholder="Item" formControlName="item" label="Item" (ionChange)="onItemChange(i)" readonly>
                    @for(item of getUpdateAvailableItems(i); track item) {
                      <ion-select-option [value]="item.id">{{ item.name }}</ion-select-option>
                    }
                  </ion-select>
                </ion-item>
    
                <ion-item>
                  <ion-select placeholder="Unit" formControlName="unit" label="Unit">
                    @for(unit of units; track unit) {
                      <ion-select-option [value]="unit.id">{{ unit.name }}</ion-select-option>
                    }
                  </ion-select>
                </ion-item>

                <ion-item>
                  <ion-select placeholder="Origin" formControlName="origin" label="Origin">
                    @for(origin of origins; track origin) {
                      <ion-select-option [value]="origin.id">{{ origin.name }}</ion-select-option>
                    }
                  </ion-select>
                </ion-item>
    
                <ion-item>
                  <ion-input type="number" placeholder="Quantity" formControlName="quantity" label="Quantity"></ion-input>
                </ion-item>
    
                <!-- <ion-item>
                  <ion-input type="number" placeholder="Total Sales" formControlName="total_sales" label="Total Sales" (ionChange)="onUpdateTotalSalesChange(i)"></ion-input>
                </ion-item> -->
    
                <ion-item>
                  <ion-input type="number" placeholder="Tax" formControlName="tax" label="Tax" ></ion-input>
                </ion-item>
    
                <ion-item>
                  <ion-input placeholder="Ticket No." formControlName="ticket_no" label="Ticket No."></ion-input>
                </ion-item>
    
                <ion-item>
                  <ion-select placeholder="Ticket Status" formControlName="ticket_status" label="Ticket Status">
                    <ion-select-option value="PAID">PAID</ion-select-option>
                    <ion-select-option value="UNPAID">UNPAID</ion-select-option>
                  </ion-select>
                </ion-item>
    
                <!-- <ion-button color="danger" (click)="removeItem(i)">Remove</ion-button> -->
              </ion-card-content>
            </ion-card>
            
          </div>
        </div>

        <!-- <ion-button expand="block" (click)="addItem()">Add Item</ion-button> -->


        <ion-button expand="block" type="submit" [disabled]="!updateDeliveryForm.valid" class="save-button">
          Save
        </ion-button>

      </form>
    </ion-content>
  </ng-template>
</ion-modal>

